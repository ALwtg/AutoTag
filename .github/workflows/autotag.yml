name: AutoTag Workflow

on:
  workflow_dispatch:
    inputs:
      package_zip:
        description: 'Path to the exported package zip'
        required: false
        default: 'autotag_package.zip'
      media_zip:
        description: 'Path to media zip file'
        required: false
        default: 'media.zip'
      config_file:
        description: 'Path to config file'
        required: false
        default: 'workflow_config.json'
      api_key:
        description: 'API Key (Optional)'
        required: false
  push:
    paths:
      - 'workflow_config.json'
      - 'media.zip'
      - '*.zip'

jobs:
  run-autotag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # 升级到 v4 提高稳定性

    - name: Setup Node.js
      uses: actions/setup-node@v4 # 升级到 v4
      with:
        node-version: '18'

    - name: Install Dependencies
      run: npm install puppeteer jszip http-server

    - name: Run AutoTag
      env:
        API_KEY: ${{ inputs.api_key || secrets.API_KEY }}
        ALL_SECRETS: ${{ toJSON(secrets) }}
      run: |
        # 显式处理参数，如果 inputs 为空则传入固定的默认值字符串
        node .github/scripts/run_autotag.js \
          "${{ inputs.package_zip || 'autotag_package.zip' }}" \
          "${{ inputs.media_zip || 'media.zip' }}" \
          "${{ inputs.config_file || 'workflow_config.json' }}" \
          "output"


    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: autotag-results
        path: output/
